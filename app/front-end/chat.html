<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DardaChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Facebook Messenger Color Palette */
    :root {
      --messenger-blue: #0084FF;
      --messenger-blue-dark: #006AFF;
      --messenger-light-gray: #f5f6f7;
    }
  </style>
</head>
<body class="bg-[var(--messenger-light-gray)] min-h-screen flex flex-col items-center justify-start py-10 font-sans">

  <!-- Header -->
  <h2 class="text-3xl font-bold text-[var(--messenger-blue)] mb-6">ðŸ’¬ DardaChat</h2>

  <!-- Login Section -->
  <div class="bg-white shadow-lg rounded-lg p-6 w-full max-w-md mb-6">
    <label for="senderInput" class="block text-gray-700 font-medium mb-2">Enter your sender ID</label>
    <input type="text" id="senderInput" placeholder="Enter your sender ID"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--messenger-blue)] mb-4" />
    <button id="loginButton"
      class="w-full bg-[var(--messenger-blue)] hover:bg-[var(--messenger-blue-dark)] text-white font-semibold py-2 rounded-lg transition">
      Login & Connect
    </button>
  </div>

  <!-- Chat Section -->
  <div id="chatSection" class="bg-white shadow-lg rounded-lg p-6 w-full max-w-md hidden">
    <label for="destinationInput" class="block text-gray-700 font-medium mb-2">Destination</label>
    <input type="text" id="destinationInput" placeholder="Enter destination (e.g. broadcast)"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--messenger-blue)] mb-4" />

    <label for="contentInput" class="block text-gray-700 font-medium mb-2">Message</label>
    <input type="text" id="contentInput" placeholder="Enter message content"
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--messenger-blue)] mb-4" />

    <button onclick="sendMessage()"
      class="w-full bg-[var(--messenger-blue)] hover:bg-[var(--messenger-blue-dark)] text-white font-semibold py-2 rounded-lg transition">
      Send Message
    </button>

    <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-2">Messages</h3>
    <pre id="messages"
      class="bg-[var(--messenger-light-gray)] rounded-lg p-4 h-64 overflow-y-auto text-sm font-mono whitespace-pre-wrap"></pre>
  </div>

<script>
  let socket = null;
  let senderId = "";
  let currentDestination = "";

  document.getElementById("loginButton").addEventListener("click", function () {
    senderId = document.getElementById("senderInput").value.trim();
    if (!senderId) {
      alert("Please enter a sender ID");
      return;
    }

    socket = new WebSocket(`ws://localhost:8080/api/v1/ws?id=${encodeURIComponent(senderId)}`);

    socket.onopen = function () {
      appendMessage(`âœ… Connected as "${senderId}"`);
      document.getElementById("chatSection").classList.remove("hidden");

      document.getElementById("senderInput").disabled = true;
      document.getElementById("loginButton").disabled = true;
      document.getElementById("loginButton").classList.add("opacity-50", "cursor-not-allowed");

      // When destination changes, load messages for that destination
      document.getElementById("destinationInput").addEventListener("change", function () {
        currentDestination = this.value.trim();
        if (currentDestination) {
          loadMessages(currentDestination);
        }
      });
    };

    socket.onmessage = function (event) {
      try {
        const messageEvent = JSON.parse(event.data);

        if (messageEvent.type === "Message") {
          const msg = messageEvent.content;
          appendMessage(`ðŸ“© ${msg.sender}: ${msg.content}`);
        }
      } catch (e) {
        appendMessage("{Received (raw)}: " + event.data);
      }
    };

    socket.onclose = function () {
      appendMessage("âŒ Disconnected from WebSocket server");
    };
  });

  // Load past messages
  async function loadMessages(destination) {
    appendMessage(`ðŸ•“ Loading messages for "${destination}"...`);
    try {
      const response = await fetch(`http://localhost:8080/api/v1/messages/${encodeURIComponent(destination)}?id=${encodeURIComponent(senderId)}`);
      if (!response.ok) {
        appendMessage(`âš  Failed to load messages (status ${response.status})`);
        return;
      }

      const res = await response.json();
      console.log("Loaded messages:", res);
      const messages = res.messages;

      appendMessage(`ðŸ“š Loaded ${messages.length} messages:`);

      messages.forEach(msg => {
        appendMessage(`${msg.sender === senderId ? "ðŸ“¤" : "ðŸ“©"} ${msg.sender}: ${msg.content}`);
      });

    } catch (err) {
      appendMessage("âš  Error loading messages: " + err);
    }
  }

  function sendMessage() {
    const destination = document.getElementById("destinationInput").value.trim();
    const content = document.getElementById("contentInput").value.trim();

    if (!destination || !content) {
      alert("Please fill in all fields");
      return;
    }

    currentDestination = destination;

    const message = {
      sender: senderId,
      destination: destination,
      content: content
    };

    const event = {
      type: "Message",
      content: message
    };

    socket.send(JSON.stringify(event));
    appendMessage(`ðŸ“¤ ${senderId}: ${content}`);

    document.getElementById("contentInput").value = "";
  }

  function appendMessage(text) {
    const messagesEl = document.getElementById("messages");
    messagesEl.textContent += text + "\n";
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }
</script>

</body>
</html>
